<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>API de tareas Bimbo con Auth</title>
<style>
    ul { list-style: none; padding: 0; }
    li { margin: 8px 0; padding: 8px; background: #e0f0ff; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
    button { margin-left: 5px; padding: 4px 8px; cursor: pointer; }
    .btn-group { display: flex; gap: 5px; }
</style>
</head>
<body>
<h3>API de tareas Bimbo con Auth</h3>

<!-- Login / Registro -->
<div id="auth">
    <button onclick="registrarUsuario()">Registrarse</button>
    <button onclick="loginUsuario()">Iniciar sesión</button>
</div>

<!-- Botones para tareas -->
<div id="tareasUI" style="display:none;">
    <button onclick="verTareas()">Ver tareas</button>
    <button onclick="agregarTarea()">Agregar tarea</button>

    <h4>Lista de tareas</h4>
    <ul id="listaTareas"></ul>
</div>

<script>
let token = null; // Guardará el JWT
const lista = document.getElementById("listaTareas");

// REGISTRO =)
async function registrarUsuario() {
    const usuario = prompt("Nombre de usuario:");
    if (!usuario) return;
    const contraseña = prompt("Contraseña:");
    if (!contraseña) return;

    const res = await fetch("http://localhost:3000/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario, contraseña })
    });

    const data = await res.json();
    alert(data.mensaje || data.error || JSON.stringify(data));
}

// LOGIN =)
async function loginUsuario() {
    const usuario = prompt("Usuario:");
    if (!usuario) return;
    const contraseña = prompt("Contraseña:");
    if (!contraseña) return;

    const res = await fetch("http://localhost:3000/login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario, contraseña })
    });

    const data = await res.json();
    if (data.token) {
        token = data.token;
        alert("Login con exito =)");
        document.getElementById("auth").style.display = "none";
        document.getElementById("tareasUI").style.display = "block";
        verTareas();
    } else {
        alert(data.error || "Error al iniciar sesión");
    }
}

// Mostrar tareas =)
async function verTareas() {
    lista.innerHTML = "";
    const res = await fetch("http://localhost:3000/tareas", {
        headers: { "Authorization": `Bearer ${token}` }
    });
    const data = await res.json();

    data.forEach(tarea => {
        const li = document.createElement("li");
        const span = document.createElement("span");
        span.textContent = `${tarea.titulo} - ${tarea.descripcion}`;

        const btnGroup = document.createElement("div");
        btnGroup.classList.add("btn-group");

        // Editar tarea =)
        const btnEditar = document.createElement("button");
        btnEditar.textContent = "Editar";
        btnEditar.onclick = async () => {
            const nuevoTitulo = prompt("Nuevo título:", tarea.titulo);
            if (!nuevoTitulo) return;
            const nuevaDescripcion = prompt("Nueva descripción:", tarea.descripcion);
            if (!nuevaDescripcion) return;

            await fetch(`http://localhost:3000/tareas/${tarea.id}`, {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Bearer ${token}`
                },
                body: JSON.stringify({ titulo: nuevoTitulo, descripcion: nuevaDescripcion })
            });
            verTareas();
        };

        // Eliminar tarea =)
        const btnEliminar = document.createElement("button");
        btnEliminar.textContent = "Eliminar";
        btnEliminar.onclick = async () => {
            await fetch(`http://localhost:3000/tareas/${tarea.id}`, {
                method: "DELETE",
                headers: { "Authorization": `Bearer ${token}` }
            });
            verTareas();
        };

        btnGroup.appendChild(btnEditar);
        btnGroup.appendChild(btnEliminar);

        li.appendChild(span);
        li.appendChild(btnGroup);
        lista.appendChild(li);
    });
}

// Agregar tarea =)
async function agregarTarea() {
    const titulo = prompt("Título de la nueva tarea:");
    if (!titulo) return;
    const descripcion = prompt("Descripción de la nueva tarea:");
    if (!descripcion) return;

    await fetch("http://localhost:3000/tareas", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ titulo, descripcion })
    });
    verTareas();
}
</script>
</body>
</html>
